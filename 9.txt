library(forecast)
library(ggplot2)
library(TSA)
library(tseries)

perform_eda <- function(ts_data, dataset_name) {
  cat("Exploratory Data Analysis for", dataset_name, "\n")
  print(summary(ts_data))
  plot(ts_data, main = paste(dataset_name, "Time Series"), ylab = "Values", xlab = "Time")
  acf(ts_data, main = paste("ACF of", dataset_name))
  pacf(ts_data, main = paste("PACF of", dataset_name))
}

decompose_ts <- function(ts_data, dataset_name) {
  cat("Decomposing the time series for", dataset_name, "\n")
  decomposition <- decompose(ts_data)
  plot(decomposition)
  return(decomposition)
}

fit_arima <- function(ts_data, dataset_name) {
  cat("Fitting ARIMA model for", dataset_name, "\n")
  adf_test <- adf.test(ts_data, alternative = "stationary")
  cat("ADF Test p-value:", adf_test$p.value, "\n")
  if (adf_test$p.value > 0.05) {
    ts_data <- diff(ts_data)
    plot(ts_data, main = paste(dataset_name, "Differenced Time Series"))
  }
  auto_model <- auto.arima(ts_data, seasonal = FALSE)
  print(summary(auto_model))
  plot(forecast(auto_model, h = 12), main = paste(dataset_name, "ARIMA Forecast"))
  return(auto_model)
}

fit_sarima <- function(ts_data, dataset_name) {
  cat("Fitting SARIMA model for", dataset_name, "\n")
  auto_sarima <- auto.arima(ts_data, seasonal = TRUE)
  print(summary(auto_sarima))
  plot(forecast(auto_sarima, h = 12), main = paste(dataset_name, "SARIMA Forecast"))
  return(auto_sarima)
}

compare_models <- function(arima_model, sarima_model, ts_data) {
  cat("Comparing ARIMA and SARIMA models:\n")
  h <- min(12, length(ts_data))
  arima_forecast <- forecast(arima_model, h = h)
  sarima_forecast <- forecast(sarima_model, h = h)
  actual_values <- ts_data[(length(ts_data) - h + 1):length(ts_data)]
  cat("ARIMA Accuracy:\n")
  print(accuracy(arima_forecast$mean, actual_values))
  cat("SARIMA Accuracy:\n")
  print(accuracy(sarima_forecast$mean, actual_values))
}

plot_forecast_comparison <- function(actual_values, arima_forecast, sarima_forecast, time_points) {
  arima_rmse <- sqrt(mean((arima_forecast - actual_values)^2))
  sarima_rmse <- sqrt(mean((sarima_forecast - actual_values)^2))
  better_col <- ifelse(arima_rmse < sarima_rmse, "green", "red")
  worse_col  <- ifelse(arima_rmse < sarima_rmse, "red", "green")
  plot(time_points, actual_values, type = "o", col = "blue", pch = 16,
       xlab = "Time", ylab = "Values", main = "Forecast Comparison")
  lines(time_points, arima_forecast, col = better_col, lty = 2, lwd = 2)
  lines(time_points, sarima_forecast, col = worse_col, lty = 3, lwd = 2)
  legend("topright",
         legend = c(
           "Actual",
           paste("ARIMA RMSE =", round(arima_rmse, 2)),
           paste("SARIMA RMSE =", round(sarima_rmse, 2))),
         col = c("blue", better_col, worse_col),
         lty = c(1, 2, 3), pch = c(16, NA, NA))
}

data("AirPassengers")
air_data <- AirPassengers
perform_eda(air_data, "AirPassengers")
decompose_ts(air_data, "AirPassengers")
arima_air <- fit_arima(air_data, "AirPassengers")
sarima_air <- fit_sarima(air_data, "AirPassengers")
compare_models(arima_air, sarima_air, air_data)

h_air <- 12
air_actual_values <- air_data[(length(air_data) - h_air + 1):length(air_data)]
arima_air_fc <- forecast(arima_air, h = h_air)$mean
sarima_air_fc <- forecast(sarima_air, h = h_air)$mean
time_points_air <- time(air_data)[(length(air_data) - h_air + 1):length(air_data)]
plot_forecast_comparison(air_actual_values, arima_air_fc, sarima_air_fc, time_points_air)
